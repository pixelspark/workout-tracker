{{ define "workout_map" }}
<div
  id="map"
  class="border-2 border-black rounded-xl h-[300px] sm:h-[400px] md:h-[600px] print:w-full print:h-[600px]"
  style="display: grid; grid-template-rows: 1fr 150px; gap: 5px"
>
  <div class="map-holder"></div>
  <details>
    <summary>{{ i18n "Select segment" }}</summary>
    <form>
      <div style="display: grid; grid-template-rows: 1fr 1fr">
        <input
          name="start"
          type="range"
          min="0"
          max="{{ len .Data.Details.Points }}"
        />
        <input
          name="end"
          type="range"
          min="0"
          max="{{ len .Data.Details.Points }}"
        />
        <button name="make-segment">{{i18n "Create segment"}}</button>
      </div>
    </form>
  </details>
  <script src="{{ RouteFor `assets` }}/map.js"></script>
  <script>
    (function() {
      const points = [
          {{ with .Data.Details }}
            {{ range .Points -}}
              { "lat": {{ .Lat }}, "lng": {{ .Lng }}, "speed": {{ .AverageSpeed }}, "elevation": {{ .ExtraMetrics.Get "elevation" }}, "title": "{{ template `workout_point_title` . }}", },
            {{ end  }}
          {{ end  }}
        ];

        const mapElement = document.getElementById("map");

      makeMap({
        element: mapElement.querySelector(".map-holder"),
        center: [{{ .Data.Center.Lat  }}, {{  .Data.Center.Lng  }}],
        minElevation: {{ .Data.MinElevation }},
        maxElevation: {{ .Data.MaxElevation }},
        maxSpeed: {{ .Data.MaxSpeed }},
        speedName: "{{ i18n "Average speed" }}",
        elevationName: "{{ i18n "Elevation" }}",
        points
      });

      // Attach segment selector controls
      let startPointIndex = null;
      let endPointIndex = null;
      const startPointInputElement = mapElement.querySelector("input[name='start']");
      const endPointInputElement = mapElement.querySelector("input[name='end']");
      const makeSegmentElement = mapElement.querySelector("button[name='make-segment']");
      startPointInputElement.addEventListener("change", (evt) => {
        const value = parseInt(evt.target.value, 10);
        if(value >= 0 && value < points.length) {
          startPointIndex = value;
          const startPoint = points[value];
          setGlobalMapMarker("{{ i18n "Start point" }}", startPoint.lat, startPoint.lng);
        }
      });
      endPointInputElement.addEventListener("change", (evt) => {
        const value = parseInt(evt.target.value, 10);
        if(value >= 0 && value < points.length) {
          const endPoint = points[value];
          endPointIndex = value;
          setGlobalMapMarker("{{ i18n "End point" }}", endPoint.lat, endPoint.lng);
        }
      });
      makeSegmentElement.addEventListener("click", (evt) => {
        alert("MAKE SEGMENT: from point " + startPointIndex + " to point " + endPointIndex);
        evt.stopPropagation();
        evt.preventDefault();
      });
    })();
  </script>
</div>
{{ if and (not AppConfig.SocialsDisabled) (not
CurrentUser.Profile.SocialsDisabled) }} {{ template "workout_social" .}} {{ end
}} {{ end }}
